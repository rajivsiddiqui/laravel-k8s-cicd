# Create a service account for Jenkins
kubectl create serviceaccount jenkins

# Give it admin (or limited) permissions
kubectl create clusterrolebinding jenkins-admin --clusterrole=cluster-admin --serviceaccount=default:jenkins

# Extract the token and cert
SECRET=$(kubectl get sa jenkins -o jsonpath='{.secrets[0].name}')
TOKEN=$(kubectl get secret $SECRET -o jsonpath='{.data.token}' | base64 --decode)
CERT=$(kubectl get secret $SECRET -o jsonpath='{.data.ca\.crt}')

# Get the API server URL
SERVER=$(kubectl config view --minify -o jsonpath='{.clusters[0].cluster.server}')

# Create kubeconfig file
cat <<EOF > kubeconfig
apiVersion: v1
kind: Config
clusters:
- name: cluster
  cluster:
    certificate-authority-data: $CERT
    server: $SERVER
contexts:
- name: jenkins
  context:
    cluster: cluster
    user: jenkins
current-context: jenkins
users:
- name: jenkins
  user:
    token: $TOKEN
EOF
